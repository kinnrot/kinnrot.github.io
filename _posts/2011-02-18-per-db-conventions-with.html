---
layout: post
title: Per DB Conventions With FluentNhibernate
date: '2011-02-18T11:30:00.000-08:00'
author: Chen Kinnrot
tags: 
modified_time: '2011-02-18T11:30:10.627-08:00'
thumbnail: http://4.bp.blogspot.com/-MfFJJoXqa-I/TVwVwTgRK9I/AAAAAAAACNY/bZojqTwNd1A/s72-c/Tree.PNG
blogger_id: tag:blogger.com,1999:blog-8908829452516573489.post-8264829220992827405
blogger_orig_url: http://kinnrot.blogspot.com/2011/02/per-db-conventions-with.html
---

I need to support 2 db types on my app, so I thought about a nice pattern that will help me achieve this.<br /><br /><span class="Apple-style-span" style="color: lime;">// I'm working with latest Fluent Nhibernate version.</span><br /><br />Define a folder for each db type you want to support like this:<br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-MfFJJoXqa-I/TVwVwTgRK9I/AAAAAAAACNY/bZojqTwNd1A/s1600/Tree.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-MfFJJoXqa-I/TVwVwTgRK9I/AAAAAAAACNY/bZojqTwNd1A/s1600/Tree.PNG" /></a></div><br />contain conventions for MSSQLCE and the second will contain conventions for OracleClient.<br /><br />For example: Oracle support schemas and sequences, SQLCE does not. lets define some simple conventions<br /><br />For Oracle:<br /><br /><span class="Apple-style-span" style="font-family: monospace; white-space: pre;">public class SchemaConvention : IClassConvention</span><br /><pre class="brush: csharp;">{<br />  public void Apply(IClassInstance instance)<br />  {<br />    instance.Schema("MY_ORACLE_SPECIFIC_SCHEMA");<br />  }<br />}<br /></pre><br /><pre class="brush: csharp;">public class SequenceConvention : IIdConvention<br />{<br />  public void Apply(IIdentityInstance instance)<br />  {<br />    instance.GeneratedBy.Sequence(instance.Columns.First().Name + "_SEQ");<br />  }<br />}<br /></pre><br />And for SqlCe:<br /><br /><pre class="brush: csharp;">class IdentityConvention : IIdConvention<br />{<br />  public void Apply(IIdentityInstance instance)<br />  {<br />     instance.GeneratedBy.Identity();<br />  }<br />}<br /></pre><pre class="brush: csharp;"></pre><pre class="brush: csharp;">So the folders will look like this:</pre><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-hhY8AdZIj9U/TVwYkml_xUI/AAAAAAAACNk/yhmHGgp29gs/s1600/files.GIF" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-hhY8AdZIj9U/TVwYkml_xUI/AAAAAAAACNk/yhmHGgp29gs/s1600/files.GIF" /></a></div><pre class="brush: csharp;"></pre><br />Next thing that we will need is some kind of type&nbsp;retriever&nbsp;that knows what conventions to load according to the db we are currently configuring his nhibernate stuff.<br /><br />Lets call it PerDBConventionSource and this is how its implemented:<br /><br /><pre class="brush: csharp;">internal class PerDBConventionSource : ITypeSource<br />{<br />  private readonly string _name;<br />  private IEnumerable&lt;Type&gt; _types;<br /><br />  public PerDBConventionSource(string name)<br />  {<br />    _name = name;<br />  }<br /><br />  public IEnumerable&lt;Type&gt; GetTypes()<br />  {<br />    _types = typeof (PerDBConventionSource).Assembly.GetTypes().Where(t =&gt;        t.Namespace.EndsWith(_name));<br />    return _types;<br />  }<br /><br />  /// &lt;summary&gt;<br />  /// Logs the activity of this type source.<br />  /// &lt;/summary&gt;<br />  /// &lt;param name="logger"&gt;The logger.&lt;/param&gt;<br />  public void LogSource(IDiagnosticLogger logger)<br />  {<br />    // TODO : Log if you want<br />  }<br /><br />  public string GetIdentifier()<br />  {<br />    return _name;<br />  }<br />}<br /></pre><br />Notice that i'm implementing ITypeSource, an interface belong to FluentNhibernate, this is how i tell FluentNhibernate to use this as a convention source: (I used only fluentMappings so I add the conventions only on fluentMappings)<br /><br /><br /><pre class="brush: csharp;">private static IPersistenceConfigurer _persistenceConfigurer;<br /><br />private static void ConfigureNH(IPersistenceConfigurer persistenceConfigurer)<br />{<br />  _persistenceConfigurer = persistenceConfigurer;<br />  Fluently.<br />    Configure().<br />    Database(persistenceConfigurer).<br />    Diagnostics(x =&gt; x.Enable(true).OutputToConsole()).<br />    Mappings(SomeMappings).<br />    BuildConfiguration();<br />}<br /><br />private static void SomeMappings(MappingConfiguration mappingConfiguration)<br />{<br />  string name = _persistenceConfigurer.GetType().Name.Replace("Configuration", string.Empty);<br /><br />  mappingConfiguration.FluentMappings.Conventions.AddSource(new PerDBConventionSource(name));<br />}<br /></pre><br /><br />So when I'll run the following code:<br /><br /><pre class="brush: csharp;">Console.BackgroundColor = ConsoleColor.DarkGreen;<br />Console.ForegroundColor= ConsoleColor.Green;<br /><br />ConfigureNH(OracleClientConfiguration.Oracle10.ConnectionString("some OracleClient connection"));<br /><br />Console.BackgroundColor = ConsoleColor.DarkBlue;<br />Console.ForegroundColor = ConsoleColor.Blue;<br /><br />ConfigureNH(MsSqlCeConfiguration.Standard.ConnectionString("some MsSqlCe connection"));<br /></pre><br />The result will be<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-7JDQlxsnsNs/TV56uparJZI/AAAAAAAACN4/waScYrGm_tY/s1600/or2.GIF" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="144" src="http://1.bp.blogspot.com/-7JDQlxsnsNs/TV56uparJZI/AAAAAAAACN4/waScYrGm_tY/s640/or2.GIF" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-wRwtcdZh_z8/TV56xcqDA2I/AAAAAAAACN8/nSsaowp2GTc/s1600/sql2.GIF" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="118" src="http://3.bp.blogspot.com/-wRwtcdZh_z8/TV56xcqDA2I/AAAAAAAACN8/nSsaowp2GTc/s640/sql2.GIF" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"></div><br />Why you should use his pattern anyway(even if you work with 1 db):<br />1. unit testing with sqlite in memory will not work with sequence conventions, so you shouldn't load them when you are unit testing.<br />2. If you'll some day change the db type, you'll know where to add its own conventions, just create a folder with db name and add it's conventions inside no other  change is necessary.<br /><br />You can find the source here:<br /><iframe title ="Preview" scrolling="no" marginheight="0" marginwidth="0" frameborder="0" style="width:98px;height:115px;padding:0;background-color:#fcfcfc;" src="http://cid-b7c55b5696998a0e.office.live.com/embedicon.aspx/BLGR/PerDBConventions.7z"></iframe>